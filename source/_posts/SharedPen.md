title: SharedPen å¯Œæ–‡æœ¬å®æ—¶ååŒç¼–è¾‘å™¨
date: 2018-02-27 22:39:33
tags: ['å¯Œæ–‡æœ¬', 'å®æ—¶ååŒç¼–è¾‘å™¨']
categories: SharedPen
---

![](http://7vikhl.com1.z0.glb.clouddn.com/SharedPen-Main.png)

2017 å¹´æœ«ï¼Œå…¬å¸ç»„ç»‡äº† WPS é»‘å®¢é©¬æ‹‰æ¾æ¯”èµ›å·²æ­£å¼å¼€èµ›ï¼Œæ¯”èµ›çš„ä¸»é¢˜æ˜¯ï¼šåˆ©ç”¨ WPS å®¢æˆ·ç«¯ã€äº‘ï¼ŒåŠå…¶å®ƒç¬¬ä¸‰æ–¹å¼€æ”¾æœåŠ¡ï¼Œé’ˆå¯¹æ–‡æ¡£çš„æŸ¥çœ‹ ã€åˆ›ä½œ ï¼Œä»¥åŠå·¥ä½œã€å­¦ä¹ ä¸­çš„å›¢é˜Ÿåˆ†äº«ã€åˆä½œç­‰ï¼Œæ¥æ„æƒ³å¹¶å®ç° WPS äº§å“åˆ›æ–°ç‚¹ã€‚å†²ç€ä¸»é¢˜å®½æ³›ï¼Œå¼€å‘æ—¶é—´é•¿ï¼Œä¸”ä¸€ç­‰å¥– 1 ä¸‡çš„å¥–é‡‘ ğŸ¤‘ï¼Œæ¯«ä¸çŠ¹è±«çš„æŠ¥åäº†ã€‚ç»è¿‡ä¸€ä¸ªå¤šæœˆçš„å¼€å‘ï¼ŒSharedPen å¯Œæ–‡æœ¬å®æ—¶ååŒç¼–è¾‘å™¨åŸºæœ¬åŠŸèƒ½å¼€å‘å®Œæˆï¼Œæœ€ç»ˆåœ¨è¯„å®¡ä¸­ä¹Ÿå¦‚æ„¿è·å¾—ä¸€ç­‰å¥– ğŸ‘
SharedPen ç›®å‰ä»å¤„äºå¼€å‘é˜¶æ®µï¼Œæ¬¢è¿æ„Ÿå…´è¶£çš„æœ‹å‹ä¸æˆ‘è”ç³»ä¸€èµ·äº¤æµï¼Œé¡¹ç›®åœ°å€ï¼š[GitHub: YingshanDeng/SharedPen](https://github.com/YingshanDeng/SharedPen)ã€‚æœ¬æ–‡å°†å¯¹ SharedPen æ•´ä½“æ¶æ„è¿›è¡Œä»‹ç»ï¼Œåç»­ä¼šæœ‰ç³»åˆ—æ–‡ç« ä»‹ç»å…¶ä¸­å…·ä½“çš„æŠ€æœ¯å®ç°ç»†èŠ‚(æ•¬è¯·æœŸå¾… ğŸ)ã€‚

<!-- more -->

## å…³äºååŒç¼–è¾‘å™¨
ååŒç¼–è¾‘ä¹Ÿå°±æ˜¯å¤šä¸ªäººå¯¹ä¸€ä»½æ–‡æ¡£è¿›è¡Œç¼–è¾‘ï¼Œæ¯ä¸ªåä½œè¿™éƒ½æœ‰è‡ªå·±çš„è¾“å…¥å…‰æ ‡ï¼Œå¹¶å¯ä»¥å¯ä»¥è‡ªç”±åœ°å’Œå…¶ä»–åä½œè€…ä¸€èµ·è¾“å…¥ã€‚å¯¹äº web-based çš„ååŒç¼–è¾‘å™¨ï¼Œç›®å‰æœ‰å¾ˆå¤šæˆç†Ÿçš„äº§å“ã€‚åƒæˆ‘å¾ˆå–œæ¬¢ç”¨çš„: [Google Docs](https://www.google.com/docs/about/)ï¼Œå›½å†…çš„: [çŸ³å¢¨æ–‡æ¡£](https://shimo.im/)ã€‚

å¦ä¸€ä¸ªå€¼å¾—ä»‹ç»çš„æ˜¯ [Teletype](https://teletype.atom.io/)ï¼Œè¿™æ˜¯åœ¨æ—§é‡‘å±±ä¸¾åŠçš„ 2017 QCon å¤§ä¼šä¸Šï¼ŒGitHub å‘å¸ƒçš„ Atom å®æ—¶åä½œæ’ä»¶ï¼ŒTeletype å¯ä»¥è®©ä¸¤åå¼€å‘è€…è½»æ¾çš„åä½œç¼–å†™ä»£ç ï¼Œç”±äº Atom æ˜¯åŸºäº [Electron](https://electronjs.org/) æ„å»ºçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ web-based ååŒç¼–è¾‘å™¨ã€‚

**ååŒç¼–è¾‘çš„å…³é”®æ˜¯è¦è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜**ï¼Œä¸åŒçš„åä½œè€…ä¿®æ”¹ä»–ä»¬è‡ªå·±çš„æ–‡æ¡£å‰¯æœ¬ï¼Œæœ¬åœ°çš„ç¼–è¾‘ä¼šç«‹åˆ»åº”ç”¨åˆ°æœ¬åœ°å‰¯æœ¬ï¼Œä¹‹åä¼šä¼ è¾“ç»™å…¶ä»–åä½œè€…ï¼Œè¿™ä¼šå¯¼è‡´ä¸åŒçš„å‰¯æœ¬å¯èƒ½ä¼šä»¥ä¸åŒçš„é¡ºåºåº”ç”¨å„ç§ä¿®æ”¹ï¼Œåº”è¯¥æœ‰ç®—æ³•æ¥ç¡®ä¿åœ¨ååŒç¼–è¾‘ä¹‹åï¼Œæ‰€æœ‰å‰¯æœ¬æœ€ç»ˆçš„å†…å®¹æ˜¯ä¸€è‡´çš„ã€‚

## æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ
é¦–å…ˆä»‹ç»ä¸€ä¸‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿå³è¿è¡Œåœ¨å¤šç‰©ç†è®¡ç®—æœºä¸Šçš„ç³»ç»Ÿã€‚è¿™ä¸ªæ˜¯äººç±»ç›®å‰å®é™…å¯è¡Œçš„æ„å»ºè¶…å¤§è§„æ¨¡ç³»ç»Ÿçš„å”¯äºŒåŠæ³•ä¹‹ä¸€ï¼ˆå¦ä¸€ç§å°±æ˜¯æ„å»ºè¶…çº§è®¡ç®—æœºï¼‰ã€‚æ„å»ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„éš¾ç‚¹åœ¨äºï¼šè®©åˆ†å¸ƒå¼ç³»ç»Ÿè¿ä½œèµ·æ¥æ­£ç¡®æ€§ä¸å•æœºç¨‹åºå®Œå…¨æ— äºŒã€‚è€ŒååŒç¼–è¾‘å™¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¤šç«¯çš„åä½œè€…ä¿®æ”¹æ–‡æ¡£ï¼Œè€Œæœ€ç»ˆæ–‡æ¡£å†…å®¹è¦æ”¶æ•›åˆ°ç›¸åŒçš„çŠ¶æ€
![](http://7vikhl.com1.z0.glb.clouddn.com/real-time-portals-fa6fa303e261b1679024081d6229c9f9.png)

ç›®å‰æ¥è¯´ï¼Œè§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œä¸»æµçš„æœ‰ä¸¤å¤§æ–¹æ¡ˆï¼š
- **Conflict-free replicated data type** (CRDT)
- **Operational transformation** (OT)

### Conflict-free replicated data type
Conflict-free replicated data typeï¼Œç®€ç§°ä¸º CRDTï¼Œç›´è¯‘çš„è¯å³æ˜¯ï¼šæ— å†²çªå¯å¤åˆ¶æ•°æ®ç±»å‹ã€‚
> Wikipedia ä»‹ç»: [Conflict-free replicated data type](https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type)
In distributed computing, a conflict-free replicated data type (CRDT) is a **data structure** which can be replicated across multiple computers in a network, where the replicas can be updated independently and concurrently without coordination between the replicas, and where it is always mathematically possible to resolve inconsistencies which might result.

ç®€å•çš„ç†è§£ï¼šCRDT å°±æ˜¯è¿™æ ·ä¸€äº›é€‚åº”äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯ä»¥ä¿æŒæœ€ç»ˆä¸€è‡´æ€§çš„**æ•°æ®ç»“æ„**çš„ç»Ÿç§°ã€‚GitHub å¼€æºçš„ Teletype ååŒç¼–è¾‘æ’ä»¶ï¼Œä½¿ç”¨çš„å°±æ˜¯ CRDT ç®—æ³•ã€‚GitHub ä¸ºæ­¤å¼€å‘çš„ CRDT æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº“ï¼Œæœ‰å…´è¶£å¯å‰å¾€ GitHub å…·ä½“äº†è§£ã€‚
> é¡¹ç›®åœ°å€ï¼š[atom/teletype-crdt](https://github.com/atom/teletype-crdt) String-wise sequence CRDT powering peer-to-peer collaborative editing in Teletype for Atom.

### Operational transformation
Operational transformationï¼Œç®€ç§° OTï¼Œç›´è¯‘çš„è¯å³æ˜¯ï¼šæ“ä½œè½¬æ¢
OT å®ƒèµ·æºäº 1989 å¹´å‘è¡¨çš„ä¸€ç¯‡[ç ”ç©¶è®ºæ–‡](https://dl.acm.org/citation.cfm?doid=67544.66963)ï¼Œè¿›è¿‡å¤šå¹´çš„å‘å±•ï¼Œç°åœ¨å·²ç»æ˜¯éå¸¸æˆç†Ÿçš„ä¸€è‡´æ€§è§£å†³ç®—æ³•ï¼Œå¾ˆå¤šååŒç¼–è¾‘å™¨éƒ½é‡‡ç”¨æ­¤ç®—æ³•ä½œä¸ºååŒè§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚æˆ‘ä»¬ç†ŸçŸ¥çš„ Google Docsã€‚
> Wikipedia ä»‹ç»: [Operational transformation](https://en.wikipedia.org/wiki/Operational_transformation)
Operational transformation (OT) is a technology for supporting a range of collaboration functionalities in advanced collaborative software systems. OT was originally invented for consistency maintenance and concurrency control in collaborative editing of plain text documents. Two decades of research has extended its capabilities and expanded its applications to include group undo, locking, conflict resolution, operation notification and compression, group-awareness, HTML/XML and tree-structured document editing, collaborative office productivity tools, application-sharing, and collaborative computer-aided media design tools (see OTFAQ). In 2009 OT was adopted as a core technique behind the collaboration features in Apache Wave and Google Docs.

**SharedPen ä¹Ÿæ˜¯é‡‡ç”¨ OT ä½œä¸ºååŒç¼–è¾‘è§£å†³æ–¹æ¡ˆ**ï¼Œä½¿ç”¨äº† [ot.js](https://github.com/Operational-Transformation/ot.js) åº“ï¼ŒOT ç®—æ³•å°†æœ‰å¦ä¸€ç¯‡æ–‡ç« å•ç‹¬ä»‹ç»ï¼Œæ•¬è¯·æœŸå¾… ğŸ˜‹

## å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
SharedPen æ˜¯åŸºäº web ç«¯çš„æ‰€è§å³æ‰€å¾— (WYSIWYG) ç¼–è¾‘å™¨ã€‚
![](http://7vikhl.com1.z0.glb.clouddn.com/sharedpen.png)

åœ¨ ot.js åº“ä¸­ï¼Œä½¿ç”¨ [CodeMirror](https://codemirror.net/) ä½œä¸ºæ–‡æœ¬ç¼–è¾‘å™¨ï¼ŒCodeMirror æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„ç¼–è¾‘å™¨ï¼Œå¤šç”¨äºä»£ç ç¼–è¾‘å™¨ï¼Œè­¬å¦‚åœ¨ Chrome æµè§ˆå™¨çš„è°ƒè¯•å™¨ä¸­ï¼Œå°±ä½¿ç”¨ CodeMirror ä½œä¸ºä»£ç ç¼–è¾‘å™¨ã€‚ot.js åº“åŸºäº CodeMirror å®ç°äº†ä¸€ä¸ªç®€å•çš„çº¯æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œdemo å¯ä»¥å‚è€ƒï¼š[GitHub: ot.js-demo](https://github.com/YingshanDeng/ot.js-demo)

CodeMirror ç¼–è¾‘å™¨å…·æœ‰ä¸°å¯Œå‹å¥½çš„ API æ¥å£ï¼š
- **åæ ‡ç³»ç»Ÿ**
  CodeMirror ä¸­ä»¥è¡Œä¸ºå•ä½ï¼Œé€šè¿‡ `{line, ch}` ç¬¬å‡ è¡Œçš„ç¬¬å‡ ä¸ªå­—ç¬¦å¯ä»¥å‡†ç¡®ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦å®šä½ `pos`ï¼ŒåŒæ—¶æ¯ä¸€ä¸ªå­—ç¬¦éƒ½æœ‰ä¸€ä¸ªå…¨å±€ç´¢å¼• `index`ï¼Œé€šè¿‡ `doc.posFromIndex` å’Œ `doc.indexFromPos` ä¸¤ä¸ªè¾…åŠ©æ–¹æ³•å¯ä»¥å¯¹äºŒè€…è¿›è¡Œè½¬æ¢
- **ä¸°å¯Œçš„äº‹ä»¶å›è°ƒ: `change`, `beforeChange`, `cursorActivity`...**
å…¶ä¸­ç¼–è¾‘äº‹ä»¶ `change` çš„å›è°ƒå‚æ•°ä¿¡æ¯éå¸¸ä¸°å¯Œï¼Œä¾¿äºæˆ‘ä»¬å°†å…¶è½¬æ¢æˆ OT ç®—æ³•ä¸­çš„ operation
![](http://7vikhl.com1.z0.glb.clouddn.com/codemirror-change-insert.png)
![](http://7vikhl.com1.z0.glb.clouddn.com/codemirror-change-delete.png)
- **`markText` å¯Œæ–‡æœ¬æ”¯æŒ API**
  æ³¨æ„åˆ° CodeMirror å…¶å®å¹¶ä¸æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘ï¼Œä½†æ˜¯å¾—ç›Šäº API `markText` å¯ä»¥åŠ¨æ€ä¸ºæŒ‡å®šèŒƒå›´çš„æ–‡æœ¬è®¾ç½®ä¸€ä¸ª CSS classï¼Œä¹Ÿå¯ä»¥é€šè¿‡è‡ªèº«å®ç°ä¸ºå…¶å¢åŠ å¯Œæ–‡æœ¬ç¼–è¾‘åŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨æ–‡ç« ï¼šğŸ‘‰ [SharedPen ä¹‹ AnnotationList](https://objcer.com/2018/02/27/SharedPen-AnnotationList/) ä¸­å°†è¿›è¡Œè¯¦ç»†ä»‹ç»

## æ¶æ„
 | æ¶æ„ | Server ä½œç”¨
--- | --- | ---
Google Docsï¼ŒçŸ³å¢¨æ–‡æ¡£ | C/S æ¨¡å¼ | è´Ÿè´£è½¬å‘å¤šç«¯æ“ä½œå’Œæ•°æ®æŒä¹…åŒ–å­˜å‚¨
Teletype(AtomååŒç¼–è¾‘æ’ä»¶) | Peer-to-Peer æ¨¡å¼ | è¾…åŠ©å»ºç«‹è¿æ¥(æ¡æ‰‹)

### Peer-to-Peer æ¨¡å¼
Atom ååŒç¼–è¾‘æ’ä»¶ Teletypeï¼Œé‡‡ç”¨ Peer-to-Peer æ¨¡å¼ï¼Œé€šè¿‡ WebRTC åŠ å¯†å¤šç«¯ä¹‹é—´çš„é€šä¿¡ã€‚é™¤äº†æœ€åˆçš„æ¡æ‰‹ä¾èµ–äº GitHub çš„æœåŠ¡å™¨ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ä¼ è¾“éƒ½æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼ˆä¸éœ€è¦è®¿é—® GitHub æœåŠ¡å™¨ï¼‰ã€‚
![](http://7vikhl.com1.z0.glb.clouddn.com/sharedpen-peer-to-peer.png?t=1)

### C/S æ¨¡å¼
åƒ Google Docsï¼ŒçŸ³å¢¨æ–‡æ¡£éƒ½æ˜¯é‡‡ç”¨ C/S æ¨¡å¼ä½œä¸ºå‰åç«¯æ¶æ„ï¼ŒSharedPen ä¹Ÿæ˜¯é‡‡ç”¨è¿™ç§æ¶æ„æ¨¡å¼ï¼Œå‰åç«¯å»ºç«‹ socket è¿æ¥ï¼Œç›¸äº’å®æ—¶å‘é€ operation æ“ä½œï¼ŒæœåŠ¡ç«¯ä¸­è¿˜å¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚
![](http://7vikhl.com1.z0.glb.clouddn.com/sharedpen-client-server.png)

## å‚è€ƒé“¾æ¥
[è°ˆè°ˆCRDT](http://liyu1981.github.io/what-is-CRDT/)
[åˆ†å¸ƒå¼CRDTæ¨¡å‹](http://www.jdon.com/artichect/crdt.html)
[Whatâ€™s different about the new Google Docs?](https://drive.googleblog.com/2010/05/whats-different-about-new-google-docs.html)
